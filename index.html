<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eTravel</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --ivory: #F5F2EB;
            --mistBlue: #B3C7D6;
            --warmGold: #D4B483;
            --deepGray: #333333;
            --lightGray: #E5E5E5;
        }
        body {
            background-color: var(--ivory);
            color: var(--deepGray);
            font-family: 'Noto Sans SC', sans-serif;
            padding-top: 70px;
            padding-bottom: 80px;
        }
        .text-warmGold { color: var(--warmGold) !important; }
        .text-deepGray { color: var(--deepGray) !important; }
        .bg-ivory { background-color: var(--ivory) !important; }
        
        /* Custom Utilities */
        .gold-gradient {
            background: linear-gradient(120deg, #D4B483, #E6C798);
            border: none;
            color: white;
        }
        .blue-gradient {
            background: linear-gradient(120deg, #B3C7D6, #C8D7E4);
            border: none;
            color: white;
        }
        .shadow-card { box-shadow: 0 4px 8px rgba(179, 199, 214, 0.2); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(179, 199, 214, 0.3);
        }
        .nav-bottom {
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .nav-btn {
            background: none;
            border: none;
            color: #adb5bd;
            transition: color 0.3s;
        }
        .nav-btn.active { color: var(--warmGold); }
        
        /* Form Controls */
        .form-control:focus, .form-select:focus {
            border-color: var(--warmGold);
            box-shadow: 0 0 0 0.25rem rgba(212, 180, 131, 0.25);
        }
    </style>
</head>
<body>
    <!-- Top Navbar -->
    <nav class="navbar fixed-top" style="background-color: rgba(179, 199, 214, 0.8); backdrop-filter: blur(5px); border-bottom: 1px solid rgba(212, 180, 131, 0.3);">
        <div class="container justify-content-center">
            <div class="d-flex align-items-center gap-2">
                <i class="fa-solid fa-plane-departure text-warmGold fs-4"></i>
                <h1 class="h5 fw-bold text-deepGray m-0">eTravel</h1>
            </div>
        </div>
    </nav>

    <!-- Bottom Navigation -->
    <nav class="fixed-bottom bg-white nav-bottom border-top border-warmGold">
        <div class="d-flex justify-content-around py-2">
            <button onclick="switchTab('overview')" class="nav-btn active d-flex flex-column align-items-center w-100" id="nav-overview">
                <i class="fa-solid fa-list fs-5 mb-1"></i>
                <span style="font-size: 0.75rem;">Itinerary</span>
            </button>
            <button onclick="switchTab('date-selection')" class="nav-btn d-flex flex-column align-items-center w-100" id="nav-settings">
                <i class="fa-solid fa-gear fs-5 mb-1"></i>
                <span style="font-size: 0.75rem;">Settings</span>
            </button>
            <button onclick="switchTab('expenses')" class="nav-btn d-flex flex-column align-items-center w-100" id="nav-expenses">
                <i class="fa-solid fa-wallet fs-5 mb-1"></i>
                <span style="font-size: 0.75rem;">Expenses</span>
            </button>
            <button onclick="switchTab('saved-spots')" class="nav-btn d-flex flex-column align-items-center w-100" id="nav-saved">
                <i class="fa-solid fa-star fs-5 mb-1"></i>
                <span style="font-size: 0.75rem;">Attractions</span>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container">
        
        <!-- Date Selection Section -->
        <section id="date-selection" class="mb-4 d-none page-section">
            <div class="bg-white rounded-4 shadow-card p-4 border border-mistBlue">
                <h2 class="h5 fw-bold text-deepGray mb-3">
                    <span class="text-warmGold">Itinerary Settings</span>
                </h2>
                <div class="row g-3 align-items-end">
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label small text-muted">Start Date</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label small text-muted">End Date</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label small text-muted">Start Location</label>
                        <input type="text" id="startLocation" class="form-control" placeholder="e.g. Tokyo">
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label class="form-label small text-muted">End Location</label>
                        <input type="text" id="endLocation" class="form-control" placeholder="e.g. Osaka">
                    </div>
                    <div class="col-12 d-flex gap-2">
                        <button id="saveDatesBtn" class="btn gold-gradient text-white">
                            <i class="fa-solid fa-check"></i> Save
                        </button>
                        <button id="clearDatesBtn" class="btn btn-light text-muted">
                            <i class="fa-solid fa-trash"></i> Clear
                        </button>
                    </div>
                </div>
                
                <hr class="my-4 text-mistBlue">
                <h3 class="h6 fw-bold text-deepGray mb-3">
                    <span class="text-warmGold">Reference Links</span>
                </h3>
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <input type="text" id="refTitle" class="form-control" placeholder="Title (e.g. Blog)">
                    </div>
                    <div class="col-md-6">
                        <input type="url" id="refUrl" class="form-control" placeholder="URL (https://...)">
                    </div>
                    <div class="col-md-2">
                        <button onclick="addReferenceLink()" class="btn btn-outline-secondary w-100">Add</button>
                    </div>
                </div>
                <div id="referenceLinksList" class="list-group list-group-flush rounded-3 border border-light">
                    <!-- Links go here -->
                </div>
            </div>
        </section>

        <!-- 1. Itinerary Overview -->
        <section id="overview" class="mb-5 page-section">
            <div class="bg-white rounded-4 shadow-card p-4 border border-mistBlue">
                <!-- Mobile-Optimized Header -->
                <div class="row g-3 align-items-center mb-4">
                    <div class="col-12 col-md-8">
                        <div id="itineraryHeaderContent">
                            <h2 class="h4 fw-bold text-deepGray mb-1">
                                <span class="text-warmGold">Trip</span> Itinerary
                            </h2>
                            <p class="text-muted small mb-0">Select dates to begin planning</p>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 text-md-end">
                        <button id="actionBtn" class="btn gold-gradient text-white w-100 w-md-auto shadow-sm py-2 px-4 rounded-pill">
                            <i class="fa-solid fa-plus"></i> Add Day
                        </button>
                    </div>
                </div>

                <!-- Pagination Controls -->
                <div id="paginationControls" class="d-flex justify-content-center align-items-center gap-3 mb-4 d-none">
                    <button id="prevDayBtn" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-chevron-left"></i> Prev
                    </button>
                    
                    <select id="dayPaginationSelect" class="form-select w-auto fw-bold text-warmGold border-warmGold">
                        <!-- Options populated dynamically -->
                    </select>

                    <button id="nextDayBtn" class="btn btn-outline-secondary">
                        Next <i class="fa-solid fa-chevron-right"></i>
                    </button>
                </div>

                <!-- Sortable List (Now Single Card View) -->
                <div id="itineraryList" class="mx-auto" style="max-width: 800px;">
                    <!-- Default Cards (Will be replaced if dates are selected) -->
                </div>
            </div>
        </section>

        <!-- 4. Expense Tracker (+ 記一筆) -->
        <section id="expenses" class="mb-5 d-none page-section">
            <div class="bg-white rounded-4 shadow-card p-4 border border-mistBlue">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h4 fw-bold text-deepGray m-0">
                        <span class="text-warmGold">Expense Tracker</span> · Record Spending
                    </h2>
                    <button id="openExpenseModalBtn" class="btn gold-gradient text-white shadow-sm rounded-pill px-4">
                        <i class="fa-solid fa-plus me-2"></i>Add Record
                    </button>
                </div>

                <!-- Expense List -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="p-3 border-0 rounded-start">Date</th>
                                <th class="p-3 border-0">Category</th>
                                <th class="p-3 border-0">Note</th>
                                <th class="p-3 border-0">Method</th>
                                <th class="p-3 border-0">Amount</th>
                                <th class="p-3 border-0 rounded-end">Action</th>
                            </tr>
                        </thead>
                        <tbody id="expenseListBody" class="small">
                            <!-- Records will go here -->
                            <tr>
                                <td class="p-3 text-muted" colspan="6">No records yet.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- 5. Saved Attractions -->
        <section id="saved-spots" class="mb-5 d-none page-section">
            <div class="bg-white rounded-4 shadow-card p-4 border border-mistBlue">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h4 fw-bold text-deepGray m-0">
                        <span class="text-warmGold">Saved Attractions</span> · Favorites
                    </h2>
                    <button onclick="openSavedSpotModal()" class="btn gold-gradient text-white shadow-sm rounded-pill px-4">
                        <i class="fa-solid fa-plus me-2"></i>Add New
                    </button>
                </div>
                <div id="savedSpotsList" class="row g-3">
                    <!-- Saved spots will be rendered here -->
                </div>
            </div>
        </section>
    </main>

    <!-- Modal for Adding Expense -->
    <div id="expenseModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-card">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-deepGray">Add New Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label small text-muted">Date</label>
                            <input type="date" id="expDate" class="form-control">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Amount</label>
                            <input type="number" id="expAmount" placeholder="0" class="form-control">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Currency</label>
                            <select id="expCurrency" class="form-select">
                                <option value="JPY">JPY</option>
                                <option value="USD">USD</option>
                                <option value="CNY">CNY</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Method</label>
                            <select id="expMethod" class="form-select">
                                <option value="Cash">Cash</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="IC Card">IC Card</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Category</label>
                            <select id="expCategory" class="form-select">
                                <option value="Food">Food</option>
                                <option value="Transport">Transport</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Ticket">Ticket</option>
                                <option value="Hotel">Hotel</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label small text-muted">Note (Optional)</label>
                            <input type="text" id="expNote" placeholder="Details..." class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button id="saveExpenseBtn" type="button" class="btn gold-gradient text-white">Save Record</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding Scenic Spot -->
    <div id="spotModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-card">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-deepGray" id="spotModalTitle">Add Scenic Spot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalSpotId">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Select Day</label>
                        <select id="modalDaySelect" class="form-select"></select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Spot Name</label>
                        <input type="text" id="modalSpotName" class="form-control" placeholder="e.g., Tokyo Tower">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Address</label>
                        <input type="text" id="modalSpotAddress" class="form-control" placeholder="e.g., Minato City, Tokyo">
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">Start Time</label>
                            <input type="time" id="modalSpotStartTime" class="form-control">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">End Time</label>
                            <input type="time" id="modalSpotEndTime" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button id="modalCancelBtn" type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button id="modalAddBtn" type="button" class="btn gold-gradient text-white">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Saved Attraction -->
    <div id="savedSpotModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-card">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-deepGray" id="savedSpotModalTitle">Saved Attraction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="savedSpotId">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Name</label>
                        <input type="text" id="savedSpotName" class="form-control" placeholder="e.g., Kyoto Temple">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Address</label>
                        <input type="text" id="savedSpotAddress" class="form-control" placeholder="Address...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label small text-muted">Note</label>
                        <textarea id="savedSpotNote" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button onclick="saveSavedSpot()" type="button" class="btn gold-gradient text-white">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Moving Day Content -->
    <div id="moveDayModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content border-0 shadow-card">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-deepGray">Swap Day Content</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="moveFromDayIndex">
                    <p class="small text-muted">Swap content of <span id="moveFromDayLabel" class="fw-bold"></span> with:</p>
                    <select id="moveToDaySelect" class="form-select"></select>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button onclick="confirmMoveDay()" type="button" class="btn gold-gradient text-white">Swap</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Adding Saved Spot to Itinerary -->
    <div id="addToItineraryModal" class="modal fade" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-card">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-deepGray">Add to Itinerary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="addSpotId">
                    <div class="mb-3">
                        <p class="small text-muted mb-1">Add <span id="addSpotNameLabel" class="fw-bold text-dark"></span> to:</p>
                        <select id="addToDaySelect" class="form-select"></select>
                    </div>
                    <div class="row g-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">Start Time</label>
                            <input type="time" id="addToStartTime" class="form-control">
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">End Time</label>
                            <input type="time" id="addToEndTime" class="form-control">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button onclick="confirmAddToItinerary()" type="button" class="btn gold-gradient text-white">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Scripts -->
    <script>
        // Initialize Bootstrap Modal
        let spotModalBS = null;

        document.addEventListener('DOMContentLoaded', function() {
            // 1. Sortable
            const itineraryList = document.getElementById('itineraryList');
            new
            // 2. Init Logic
            bindButtonEvents();
            initExpenseTracker();
            
            // Set default date to today for expense
            document.getElementById('expDate').valueAsDate = new Date();

            // 3. Load Saved Settings
            loadSavedSettings();
            
            // 4. Init Saved Spots
            initSavedSpots();

            // 5. Init Reference Links
            renderReferenceLinks();
        });

        // --- Tab Switching Logic ---
        window.switchTab = function(tabId) {
            // Hide all sections
            document.querySelectorAll('.page-section').forEach(el => el.classList.add('d-none'));
            // Show selected
            document.getElementById(tabId).classList.remove('d-none');
            
            // Update Nav State
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Highlight active nav
            let activeBtnId = '';
            if(tabId === 'overview') activeBtnId = 'nav-overview';
            if(tabId === 'date-selection') activeBtnId = 'nav-settings';
            if(tabId === 'expenses') activeBtnId = 'nav-expenses';
            if(tabId === 'saved-spots') activeBtnId = 'nav-saved';
            
            const activeBtn = document.getElementById(activeBtnId);
            if(activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // --- Date & Itinerary Logic ---
        let currentDayIndex = 0;
        let totalTripDays = 0;
        let tripStartDateObj = null;

        function loadSavedSettings() {
            const start = localStorage.getItem('tripStartDate');
            const end = localStorage.getItem('tripEndDate');
            const startLoc = localStorage.getItem('tripStartLoc') || '';
            const endLoc = localStorage.getItem('tripEndLoc') || '';

            if (start && end) {
                document.getElementById('startDate').value = start;
                document.getElementById('endDate').value = end;
                document.getElementById('startLocation').value = startLoc;
                document.getElementById('endLocation').value = endLoc;
                generateItinerary(start, end, startLoc, endLoc);
            }
        }

        function bindButtonEvents() {
            const saveDatesBtn = document.getElementById('saveDatesBtn');
            const clearDatesBtn = document.getElementById('clearDatesBtn');
            const actionBtn = document.getElementById('actionBtn');
            
            // Modal Elements
            const modal = document.getElementById('spotModal');
            const modalAddBtn = document.getElementById('modalAddBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            // Pagination Elements
            const prevBtn = document.getElementById('prevDayBtn');
            const nextBtn = document.getElementById('nextDayBtn');
            const pageSelect = document.getElementById('dayPaginationSelect');

            // Save Dates
            saveDatesBtn.addEventListener('click', function() {
                const start = document.getElementById('startDate').value;
                const end = document.getElementById('endDate').value;
                const startLoc = document.getElementById('startLocation').value;
                const endLoc = document.getElementById('endLocation').value;

                if (!start || !end) {
                    alert('Please select both start and end dates.');
                    return;
                }
                
                // Save to LocalStorage
                localStorage.setItem('tripStartDate', start);
                localStorage.setItem('tripEndDate', end);
                localStorage.setItem('tripStartLoc', startLoc);
                localStorage.setItem('tripEndLoc', endLoc);

                generateItinerary(start, end, startLoc, endLoc);
            });

            // Clear Dates
            clearDatesBtn.addEventListener('click', function() {
                if(!confirm('Are you sure you want to clear all data?')) return;
                
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                document.getElementById('startLocation').value = '';
                document.getElementById('endLocation').value = '';
                
                localStorage.removeItem('tripStartDate');
                localStorage.removeItem('tripEndDate');
                localStorage.removeItem('tripStartLoc');
                localStorage.removeItem('tripEndLoc');
                localStorage.removeItem('tripSpots'); 
                localStorage.removeItem('tripExpenses');
                localStorage.removeItem('currentDayIndex');
                
                location.reload(); 
            });

            // Modal Actions
            modalAddBtn.addEventListener('click', () => {
                const dayIndex = document.getElementById('modalDaySelect').value;
                const name = document.getElementById('modalSpotName').value;
                const address = document.getElementById('modalSpotAddress').value;
                const startTime = document.getElementById('modalSpotStartTime').value;
                const endTime = document.getElementById('modalSpotEndTime').value;
                const spotId = document.getElementById('modalSpotId').value;

                if(!name) {
                    alert('Please enter a spot name');
                    return;
                }

                saveSpot(dayIndex, name, address, startTime, endTime, spotId);
                
                spotModalBS.hide();
            });
            
            // Default Action Button (Add Scenic Spot)
             actionBtn.onclick = function() {
                if(totalTripDays > 0) {
                    openSpotModal(totalTripDays);
                } else {
                    alert('Please set dates first.');
                }
            };

            // Pagination Events
            prevBtn.addEventListener('click', () => {
                if(currentDayIndex > 0) {
                    currentDayIndex--;
                    renderDay(currentDayIndex);
                    updatePaginationControls();
                }
            });

            nextBtn.addEventListener('click', () => {
                if(currentDayIndex < totalTripDays - 1) {
                    currentDayIndex++;
                    renderDay(currentDayIndex);
                    updatePaginationControls();
                }
            });

            pageSelect.addEventListener('change', (e) => {
                currentDayIndex = parseInt(e.target.value);
                renderDay(currentDayIndex);
                updatePaginationControls();
            });
        }

        function generateItinerary(start, end, startLoc, endLoc) {
            tripStartDateObj = new Date(start);
            const endDate = new Date(end);
            const diffTime = Math.abs(endDate - tripStartDateObj);
            totalTripDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

            if (totalTripDays <= 0) {
                alert('End date must be after start date.');
                return;
            }

            const headerContent = document.getElementById('itineraryHeaderContent');
            const actionBtn = document.getElementById('actionBtn');
            const paginationControls = document.getElementById('paginationControls');
            const pageSelect = document.getElementById('dayPaginationSelect');

            // Update Header
            const locString = (startLoc && endLoc) ? `${startLoc} <i class="fa-solid fa-arrow-right mx-1 text-muted opacity-50"></i> ${endLoc}` : 'Itinerary';
            
            headerContent.innerHTML = `
                <div class="d-flex flex-column">
                    <span class="display-6 fw-bold text-warmGold mb-1" style="letter-spacing: -1px;">${totalTripDays} Days</span>
                    <h3 class="h5 fw-bold text-deepGray mb-2">${locString}</h3>
                    <div class="d-flex align-items-center text-muted small bg-light rounded-pill px-3 py-1 align-self-start">
                        <i class="fa-regular fa-calendar me-2 text-warmGold"></i>
                        <span class="fw-medium">${start}</span>
                        <span class="mx-2 opacity-50">|</span>
                        <span class="fw-medium">${end}</span>
                    </div>
                </div>
            `;

            // Update Button
            actionBtn.innerHTML = '<i class="fa-solid fa-camera me-2"></i>Add Spot';
            actionBtn.onclick = function() {
                openSpotModal(totalTripDays);
            };

            // Setup Pagination
            paginationControls.classList.remove('d-none');
            pageSelect.innerHTML = '';
            for(let i=0; i<totalTripDays; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = `Day ${i+1}`;
                pageSelect.appendChild(opt);
            }

            // Restore saved day index or default to 0
            const savedDayIndex = parseInt(localStorage.getItem('currentDayIndex'));
            if (!isNaN(savedDayIndex) && savedDayIndex >= 0 && savedDayIndex < totalTripDays) {
                currentDayIndex = savedDayIndex;
            } else {
                currentDayIndex = 0;
            }

            renderDay(currentDayIndex);
            updatePaginationControls();
        }

        function updatePaginationControls() {
            document.getElementById('prevDayBtn').disabled = (currentDayIndex === 0);
            document.getElementById('nextDayBtn').disabled = (currentDayIndex === totalTripDays - 1);
            document.getElementById('dayPaginationSelect').value = currentDayIndex;
            
            // Save current day index
            localStorage.setItem('currentDayIndex', currentDayIndex);
        }

        function renderDay(dayIndex) {
            const itineraryList = document.getElementById('itineraryList');
            itineraryList.innerHTML = ''; // Clear current view

            const currentDate = new Date(tripStartDateObj);
            currentDate.setDate(tripStartDateObj.getDate() + dayIndex);
            const dateString = currentDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const card = document.createElement('div');
            card.id = `day-card-${dayIndex}`;
            card.className = 'card border-0 shadow-card rounded-4 overflow-hidden mb-4 card-hover';
            card.innerHTML = `
                <div class="card-header bg-white border-bottom border-mistBlue p-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="d-flex align-items-center gap-2">
                                <h3 class="h2 fw-bold text-deepGray mb-1">Day ${dayIndex + 1}</h3>
                                <button onclick="openMoveDayModal(${dayIndex})" class="btn btn-sm btn-outline-secondary rounded-circle" style="width: 32px; height: 32px; padding: 0;" title="Swap Content">
                                    <i class="fa-solid fa-arrow-right-arrow-left"></i>
                                </button>
                            </div>
                            <p class="text-muted fw-medium m-0"><i class="fa-solid fa-calendar-day"></i> ${dateString}</p>
                        </div>
                        <div class="text-warmGold opacity-25 display-4">
                            <i class="fa-solid fa-plane-departure"></i>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4 bg-ivory spots-container">
                    <!-- Spots will be added here -->
                    <div class="text-center text-muted border border-2 border-dashed border-mistBlue rounded-4 p-5 empty-placeholder">
                        <i class="fa-solid fa-camera display-4 mb-3 opacity-50"></i>
                        <p class="mb-1">No spots added yet.</p>
                        <p class="small">Click "Add Spot" to plan this day.</p>
                    </div>
                </div>
            `;
            itineraryList.appendChild(card);

            // Load Spots
            const savedSpots = JSON.parse(localStorage.getItem('tripSpots')) || {};
            if (savedSpots[dayIndex] && savedSpots[dayIndex].length > 0) {
                const placeholder = card.querySelector('.empty-placeholder');
                if(placeholder) placeholder.remove();

                // Sort spots by start time if available
                savedSpots[dayIndex].sort((a, b) => {
                    if(!a.startTime) return 1;
                    if(!b.startTime) return -1;
                    return a.startTime.localeCompare(b.startTime);
                });

                savedSpots[dayIndex].forEach(spot => {
                    renderSpot(dayIndex, spot);
                });
            }
        }

        function openSpotModal(totalDays, spotToEdit = null) {
            const select = document.getElementById('modalDaySelect');
            const title = document.getElementById('spotModalTitle');
            const btn = document.getElementById('modalAddBtn');
            
            // Populate Select
            select.innerHTML = '';
            for(let i=0; i<totalDays; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.text = `Day ${i+1}`;
                if(i === currentDayIndex) option.selected = true; 
                select.appendChild(option);
            }

            if (spotToEdit) {
                title.textContent = 'Edit Scenic Spot';
                btn.textContent = 'Update';
                document.getElementById('modalSpotId').value = spotToEdit.id;
                document.getElementById('modalSpotName').value = spotToEdit.name;
                document.getElementById('modalSpotAddress').value = spotToEdit.address;
                document.getElementById('modalSpotStartTime').value = spotToEdit.startTime;
                document.getElementById('modalSpotEndTime').value = spotToEdit.endTime;
                select.value = spotToEdit.dayIndex; 
            } else {
                title.textContent = 'Add Scenic Spot';
                btn.textContent = 'Add';
                document.getElementById('modalSpotId').value = '';
                document.getElementById('modalSpotName').value = '';
                document.getElementById('modalSpotAddress').value = '';
                document.getElementById('modalSpotStartTime').value = '';
                document.getElementById('modalSpotEndTime').value = '';
            }

            spotModalBS.show();
        }

        function saveSpot(dayIndex, name, address, startTime, endTime, spotId) {
            const savedSpots = JSON.parse(localStorage.getItem('tripSpots')) || {};
            
            if (spotId) {
                // Edit Mode
                let oldDayIndex = -1;
                for (const d in savedSpots) {
                    const idx = savedSpots[d].findIndex(s => s.id == spotId);
                    if (idx !== -1) {
                        oldDayIndex = d;
                        if (d == dayIndex) {
                            // Update in place
                            savedSpots[d][idx] = { ...savedSpots[d][idx], name, address, startTime, endTime };
                        } else {
                            // Move to new day
                            const spot = savedSpots[d][idx];
                            savedSpots[d].splice(idx, 1);
                            if (!savedSpots[dayIndex]) savedSpots[dayIndex] = [];
                            savedSpots[dayIndex].push({ ...spot, name, address, startTime, endTime });
                        }
                        break;
                    }
                }
            } else {
                // Add Mode
                const spot = {
                    id: Date.now(),
                    name: name,
                    address: address,
                    startTime: startTime,
                    endTime: endTime
                };
                if (!savedSpots[dayIndex]) {
                    savedSpots[dayIndex] = [];
                }
                savedSpots[dayIndex].push(spot);
            }

            localStorage.setItem('tripSpots', JSON.stringify(savedSpots));
            renderDay(currentDayIndex);
        }

        window.editSpot = function(dayIndex, spotId) {
            const savedSpots = JSON.parse(localStorage.getItem('tripSpots')) || {};
            const spots = savedSpots[dayIndex];
            const spot = spots.find(s => s.id == spotId);
            if (spot) {
                spot.dayIndex = dayIndex;
                openSpotModal(totalTripDays, spot);
            }
        };

        function renderSpot(dayIndex, spot) {
            const card = document.getElementById(`day-card-${dayIndex}`);
            if(!card) return;

            const container = card.querySelector('.spots-container');
            
            const spotDiv = document.createElement('div');
            spotDiv.id = `spot-${spot.id}`;
            // Redesigned Spot Container
            spotDiv.className = 'card border-0 shadow-sm mb-3 overflow-hidden group';
            
            const timeDisplay = (spot.startTime || spot.endTime) 
                ? `${spot.startTime || '?'} - ${spot.endTime || '?'}` 
                : 'Anytime';

            const addressUrl = spot.address 
                ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(spot.address)}` 
                : '#';

            spotDiv.innerHTML = `
                <div class="row g-0">
                    <!-- Time Section -->
                    <div class="col-md-3 bg-light d-flex flex-column justify-content-center align-items-center text-center p-3 border-end border-light">
                        <span class="text-warmGold fw-bold small"><i class="fa-regular fa-clock"></i></span>
                        <span class="text-deepGray fw-semibold small mt-1">${timeDisplay}</span>
                    </div>
                    
                    <!-- Content Section -->
                    <div class="col-md-9 p-3 d-flex justify-content-between align-items-start">
                        <div>
                            <h4 class="h6 fw-bold text-deepGray mb-1">${spot.name}</h4>
                            ${spot.address ? `
                                <a href="${addressUrl}" target="_blank" class="small text-muted text-decoration-none hover-gold d-flex align-items-center gap-1">
                                    <i class="fa-solid fa-location-dot"></i> ${spot.address}
                                </a>
                            ` : ''}
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-link text-muted p-0" onclick="editSpot('${dayIndex}', ${spot.id})">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button class="btn btn-link text-muted p-0" onclick="deleteSpot('${dayIndex}', ${spot.id})">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(spotDiv);
        }

        function deleteSpot(dayIndex, spotId) {
            if(!confirm('Are you sure you want to delete this spot?')) return;
            
            const savedSpots = JSON.parse(localStorage.getItem('tripSpots')) || {};
            if (savedSpots[dayIndex]) {
                savedSpots[dayIndex] = savedSpots[dayIndex].filter(s => s.id !== spotId);
                localStorage.setItem('tripSpots', JSON.stringify(savedSpots));
                renderDay(dayIndex);
            }
        }

        function initExpenseTracker() {
            const openModalBtn = document.getElementById('openExpenseModalBtn');
            const saveBtn = document.getElementById('saveExpenseBtn');
            const listBody = document.getElementById('expenseListBody');
            
            // Init Modal
            const expenseModal = new bootstrap.Modal(document.getElementById('expenseModal'));

            // Load from Storage
            let expenses = JSON.parse(localStorage.getItem('tripExpenses')) || [];
            renderExpenses();

            openModalBtn.addEventListener('click', () => {
                // Set default date to today
                document.getElementById('expDate').valueAsDate = new Date();
                expenseModal.show();
            });

            saveBtn.addEventListener('click', function() {
                const date = document.getElementById('expDate').value;
                const amount = document.getElementById('expAmount').value;
                const currency = document.getElementById('expCurrency').value;
                const method = document.getElementById('expMethod').value;
                const category = document.getElementById('expCategory').value;
                const note = document.getElementById('expNote').value;

                if (!date || !amount) {
                    alert('Please fill in Date and Amount.');
                    return;
                }

                const record = { date, amount, currency, method, category, note, id: Date.now() };
                expenses.push(record);
                saveAndRender();
                
                // Clear inputs and close
                document.getElementById('expAmount').value = '';
                document.getElementById('expNote').value = '';
                expenseModal.hide();
            });

            window.deleteExpense = function(id) {
                if(!confirm('Delete this record?')) return;
                expenses = expenses.filter(e => e.id !== id);
                saveAndRender();
            };

            function saveAndRender() {
                localStorage.setItem('tripExpenses', JSON.stringify(expenses));
                renderExpenses();
            }

            function renderExpenses() {
                listBody.innerHTML = '';
                if (expenses.length === 0) {
                    listBody.innerHTML = '<tr><td class="p-3 text-muted" colspan="6">No records yet.</td></tr>';
                    return;
                }

                // Sort by date desc
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                expenses.forEach(exp => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="p-3">${exp.date}</td>
                        <td class="p-3"><span class="badge bg-light text-dark border">${exp.category}</span></td>
                        <td class="p-3">${exp.note}</td>
                        <td class="p-3">${exp.method}</td>
                        <td class="p-3 fw-bold text-warmGold">${exp.amount} ${exp.currency}</td>
                        <td class="p-3">
                            <button onclick="deleteExpense(${exp.id})" class="btn btn-sm btn-outline-danger border-0">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    `;
                    listBody.appendChild(tr);
                });
            }
        }

        // --- Saved Spots Logic ---
        let savedSpotsModalBS = null;
        let addToItineraryModalBS = null;

        function initSavedSpots() {
            savedSpotsModalBS = new bootstrap.Modal(document.getElementById('savedSpotModal'));
            addToItineraryModalBS = new bootstrap.Modal(document.getElementById('addToItineraryModal'));
            renderSavedSpots();
        }

        function renderSavedSpots() {
            const list = document.getElementById('savedSpotsList');
            const saved = JSON.parse(localStorage.getItem('savedAttractions')) || [];
            
            list.innerHTML = '';
            if(saved.length === 0) {
                list.innerHTML = '<div class="col-12 text-center text-muted py-5">No saved attractions yet.</div>';
                return;
            }

            saved.forEach(spot => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4';
                col.innerHTML = `
                    <div class="card h-100 border-0 shadow-sm card-hover">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title fw-bold text-deepGray mb-0">${spot.name}</h5>
                                <div class="dropdown">
                                    <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown">
                                        <i class="fa-solid fa-ellipsis-vertical"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                                        <li><button class="dropdown-item" onclick="editSavedSpot(${spot.id})"><i class="fa-solid fa-pen me-2"></i>Edit</button></li>
                                        <li><button class="dropdown-item text-danger" onclick="deleteSavedSpot(${spot.id})"><i class="fa-solid fa-trash me-2"></i>Delete</button></li>
                                    </ul>
                                </div>
                            </div>
                            <p class="card-text small text-muted mb-2"><i class="fa-solid fa-location-dot me-1"></i> ${spot.address || 'No address'}</p>
                            <p class="card-text small text-muted fst-italic">${spot.note || ''}</p>
                            <button onclick="openAddToItineraryModal(${spot.id})" class="btn btn-sm btn-outline-secondary w-100 mt-3">
                                <i class="fa-solid fa-plus me-1"></i> Add to Itinerary
                            </button>
                        </div>
                    </div>
                `;
                list.appendChild(col);
            });
        }

        window.openSavedSpotModal = function(spotId = null) {
            const title = document.getElementById('savedSpotModalTitle');
            const idInput = document.getElementById('savedSpotId');
            const nameInput = document.getElementById('savedSpotName');
            const addrInput = document.getElementById('savedSpotAddress');
            const noteInput = document.getElementById('savedSpotNote');

            if(spotId) {
                const saved = JSON.parse(localStorage.getItem('savedAttractions')) || [];
                const spot = saved.find(s => s.id === spotId);
                if(spot) {
                    title.textContent = 'Edit Attraction';
                    idInput.value = spot.id;
                    nameInput.value = spot.name;
                    addrInput.value = spot.address;
                    noteInput.value = spot.note;
                }
            } else {
                title.textContent = 'Add Attraction';
                idInput.value = '';
                nameInput.value = '';
                addrInput.value = '';
                noteInput.value = '';
            }
            savedSpotsModalBS.show();
        }

        window.saveSavedSpot = function() {
            const id = document.getElementById('savedSpotId').value;
            const name = document.getElementById('savedSpotName').value;
            const address = document.getElementById('savedSpotAddress').value;
            const note = document.getElementById('savedSpotNote').value;

            if(!name) {
                alert('Name is required');
                return;
            }

            let saved = JSON.parse(localStorage.getItem('savedAttractions')) || [];
            
            if(id) {
                const idx = saved.findIndex(s => s.id == id);
                if(idx !== -1) {
                    saved[idx] = { ...saved[idx], name, address, note };
                }
            } else {
                saved.push({ id: Date.now(), name, address, note });
            }

            localStorage.setItem('savedAttractions', JSON.stringify(saved));
            savedSpotsModalBS.hide();
            renderSavedSpots();
        }

        window.editSavedSpot = function(id) {
            openSavedSpotModal(id);
        }

        window.deleteSavedSpot = function(id) {
            if(!confirm('Delete this attraction?')) return;
            let saved = JSON.parse(localStorage.getItem('savedAttractions')) || [];
            saved = saved.filter(s => s.id !== id);
            localStorage.setItem('savedAttractions', JSON.stringify(saved));
            renderSavedSpots();
        }

        window.openAddToItineraryModal = function(spotId) {
            if(totalTripDays <= 0) {
                alert('Please set up your trip dates first.');
                return;
            }
            
            const saved = JSON.parse(localStorage.getItem('savedAttractions')) || [];
            const spot = saved.find(s => s.id === spotId);
            if(!spot) return;

            document.getElementById('addSpotId').value = spotId;
            document.getElementById('addSpotNameLabel').textContent = spot.name;
            document.getElementById('addToStartTime').value = '';
            document.getElementById('addToEndTime').value = '';
            
            const select = document.getElementById('addToDaySelect');
            select.innerHTML = '';
            for(let i=0; i<totalTripDays; i++) {
                const opt = document.createElement('option');
                opt.value = i;
                opt.text = `Day ${i+1}`;
                select.appendChild(opt);
            }
            
            addToItineraryModalBS.show();
        }

        window.confirmAddToItinerary = function() {
            const spotId = parseInt(document.getElementById('addSpotId').value);
            const dayIndex = document.getElementById('addToDaySelect').value;
            const startTime = document.getElementById('addToStartTime').value;
            const endTime = document.getElementById('addToEndTime').value;
            
            const saved = JSON.parse(localStorage.getItem('savedAttractions')) || [];
            const spot = saved.find(s => s.id === spotId);
            
            if(spot) {
                saveSpot(dayIndex, spot.name, spot.address, startTime, endTime, null);
                alert('Added to itinerary!');
                addToItineraryModalBS.hide();
            }
        }

        // --- Reference Links Logic ---
        window.addReferenceLink = function() {
            const title = document.getElementById('refTitle').value;
            const url = document.getElementById('refUrl').value;

            if(!title || !url) {
                alert('Please enter both title and URL');
                return;
            }

            const links = JSON.parse(localStorage.getItem('tripRefLinks')) || [];
            links.push({ id: Date.now(), title, url });
            localStorage.setItem('tripRefLinks', JSON.stringify(links));
            
            document.getElementById('refTitle').value = '';
            document.getElementById('refUrl').value = '';
            renderReferenceLinks();
        }

        window.deleteReferenceLink = function(id) {
            if(!confirm('Delete this link?')) return;
            let links = JSON.parse(localStorage.getItem('tripRefLinks')) || [];
            links = links.filter(l => l.id !== id);
            localStorage.setItem('tripRefLinks', JSON.stringify(links));
            renderReferenceLinks();
        }

        window.renderReferenceLinks = function() {
            const list = document.getElementById('referenceLinksList');
            const links = JSON.parse(localStorage.getItem('tripRefLinks')) || [];
            
            list.innerHTML = '';
            if(links.length === 0) {
                list.innerHTML = '<div class="text-muted small text-center py-3">No links saved yet.</div>';
                return;
            }

            links.forEach(link => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center bg-transparent';
                item.innerHTML = `
                    <a href="${link.url}" target="_blank" class="text-decoration-none text-deepGray fw-medium">
                        <i class="fa-solid fa-link me-2 text-warmGold"></i>${link.title}
                    </a>
                    <button onclick="deleteReferenceLink(${link.id})" class="btn btn-sm btn-link text-danger p-0">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
                list.appendChild(item);
            });
        }

        // --- Move Day Logic ---
        let moveDayModalBS = null;

        window.openMoveDayModal = function(dayIndex) {
            if(!moveDayModalBS) {
                moveDayModalBS = new bootstrap.Modal(document.getElementById('moveDayModal'));
            }
            
            document.getElementById('moveFromDayIndex').value = dayIndex;
            document.getElementById('moveFromDayLabel').textContent = `Day ${dayIndex + 1}`;
            
            const select = document.getElementById('moveToDaySelect');
            select.innerHTML = '';
            for(let i=0; i<totalTripDays; i++) {
                if(i !== dayIndex) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = `Day ${i+1}`;
                    select.appendChild(opt);
                }
            }
            
            moveDayModalBS.show();
        }

        window.confirmMoveDay = function() {
            const fromIndex = parseInt(document.getElementById('moveFromDayIndex').value);
            const toIndex = parseInt(document.getElementById('moveToDaySelect').value);
            
            const savedSpots = JSON.parse(localStorage.getItem('tripSpots')) || {};
            
            const fromSpots = savedSpots[fromIndex] || [];
            const toSpots = savedSpots[toIndex] || [];
            
            // Swap
            savedSpots[fromIndex] = toSpots;
            savedSpots[toIndex] = fromSpots;
            
            // Update dayIndex property inside spots if we track it there (we do in editSpot logic)
            if(savedSpots[fromIndex]) savedSpots[fromIndex].forEach(s => s.dayIndex = fromIndex);
            if(savedSpots[toIndex]) savedSpots[toIndex].forEach(s => s.dayIndex = toIndex);

            localStorage.setItem('tripSpots', JSON.stringify(savedSpots));
            
            moveDayModalBS.hide();
            renderDay(currentDayIndex); // Re-render current view
            alert(`Swapped Day ${fromIndex+1} with Day ${toIndex+1}`);
        }
    </script>
</body>
</html>
